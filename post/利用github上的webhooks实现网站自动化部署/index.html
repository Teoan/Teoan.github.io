<!doctype html><html lang=zh-cn data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.108.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/icons8-%e5%85%a5%e5%8f%a3-gradient-16.png><link rel=icon type=image/x-icon href=/imgs/icons/icons8-%e5%85%a5%e5%8f%a3-gradient-16.png><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/icons8-%e5%85%a5%e5%8f%a3-gradient-32.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/icons8-%e5%85%a5%e5%8f%a3-gradient-96.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/icons8-%e5%85%a5%e5%8f%a3-gradient-120.png><meta itemprop=name content="利用Github上的Webhooks实现网站自动化部署"><meta itemprop=description content="保持对技术的热爱"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://teoan.github.io/imgs/profile_20180304_000045_1.png"><meta itemprop=keywords content="Git,Nginx"><meta property="og:type" content="article"><meta property="og:title" content="利用Github上的Webhooks实现网站自动化部署"><meta property="og:description" content="保持对技术的热爱"><meta property="og:image" content="/imgs/profile_20180304_000045_1.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://teoan.github.io/post/%E5%88%A9%E7%94%A8github%E4%B8%8A%E7%9A%84webhooks%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"><meta property="og:site_name" content="Teoan's Notes"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Teoan"><meta property="article:published_time" content="2019-11-18 13:16:24 +0000 UTC"><meta property="article:modified_time" content="2019-11-18 13:16:24 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.8dfa56c63ced9d8fef37c21ecb7cbc0dcac8c2862affd6eacfb5ea8ae5fb775c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"%E5%88%A9%E7%94%A8github%E4%B8%8A%E7%9A%84webhooks%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2","permalink":"https://teoan.github.io/post/%E5%88%A9%E7%94%A8github%E4%B8%8A%E7%9A%84webhooks%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/","title":"利用Github上的Webhooks实现网站自动化部署","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>利用Github上的Webhooks实现网站自动化部署 - Teoan's Notes</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Teoan's Notes</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>积一时之跬步 臻千里之遥程</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>16</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#安装依赖>安装依赖</a></li><li><a href=#安装webhooks后端服务所需要的组件>安装webhooks后端服务所需要的组件</a></li><li><a href=#创建自动化部署脚本文件deploysh>创建自动化部署脚本文件deploy.sh</a></li><li><a href=#创建webhook后端运行代码>创建Webhook后端运行代码</a></li><li><a href=#使用pm2进程管理器运行webhookjs>使用pm2进程管理器运行webhook.js</a></li><li><a href=#配置nginx>配置Nginx</a></li><li><a href=#配置github上的webhook>配置Github上的Webhook</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Teoan src=/imgs/img-lazy-loading.gif data-src=/imgs/profile_20180304_000045_1.png><p class=site-author-name itemprop=name>Teoan</p><div class=site-description itemprop=description>保持对技术的热爱</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>16</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>2</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>22</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/Teoan title="Github → https://github.com/Teoan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=mailto:d277077411@gmail.com title="E-Mail → mailto:d277077411@gmail.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2018-08-28T11:27:03+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=29016></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=68></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-06-23T19:35:40+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/Teoan rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://teoan.github.io/post/%E5%88%A9%E7%94%A8github%E4%B8%8A%E7%9A%84webhooks%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/profile_20180304_000045_1.png"><meta itemprop=name content="Teoan"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Teoan"><meta itemprop=description content="保持对技术的热爱"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="利用Github上的Webhooks实现网站自动化部署"><meta itemprop=description content="前言 由于本人的hexo博客是提交到GitHub上的，每一次更新博客都得在服务器上面手动pull更新，这样就显得十分蛋疼。所以Google了一"></span><header class=post-header><h1 class=post-title itemprop="name headline">利用Github上的Webhooks实现网站自动化部署</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2019-11-18 13:16:24 +0000 UTC" itemprop="dateCreated datePublished" datetime="2019-11-18 13:16:24 +0000 UTC">2019-11-18</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E6%8A%80%E6%9C%AF itemprop=url rel=index><span itemprop=name>技术</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>1073</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>3分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/%E5%88%A9%E7%94%A8github%E4%B8%8A%E7%9A%84webhooks%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=前言>前言</h2><p>由于本人的hexo博客是提交到GitHub上的，每一次更新博客都得在服务器上面手动pull更新，这样就显得十分蛋疼。所以Google了一下我的需求，发现了Github上的
<a href=https://developer.github.com/webhooks/ title=Webhooks rel="noopener external nofollow noreferrer" target=_blank class=exturl>Webhooks
<i class="fa fa-external-link-alt"></i>
</a>功能，为此记录下我实现的过程。</p><h2 id=安装依赖>安装依赖</h2><p>由于Webhooks使用的是NodeJS，所以需要安装npm等相关的依赖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo apt-get install nodejs
</span></span><span style=display:flex><span>sudo apt-get install npm
</span></span></code></pre></div><h2 id=安装webhooks后端服务所需要的组件>安装webhooks后端服务所需要的组件</h2><p>安装github-webhook-handler</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>npm i -S github-webhook-handler
</span></span></code></pre></div><p>安装node进程管理工具pm2</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>npm i -g pm2
</span></span></code></pre></div><h2 id=创建自动化部署脚本文件deploysh>创建自动化部署脚本文件deploy.sh</h2><p>在自定义目录下创建deploy脚本实现自动化部署，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>echo <span style=color:#e6db74>&#34;start deployment&#34;</span>
</span></span><span style=display:flex><span>cd /home/xxx/xxx.github.io
</span></span><span style=display:flex><span>git fetch --all
</span></span><span style=display:flex><span>git reset --hard origin/master
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;done&#34;</span>
</span></span></code></pre></div><p>运行时如果会出现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>cd: can&#39;t cd to /home/xxx/xxx.github.io
</span></span></code></pre></div><p>原因可能是你的shell脚本在window上编写的，这样的话到linux系统运行时就会出现编码格式问题，window为dos而linux为unix。解决：
使用vim更改文件格式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>vim deploy.sh
</span></span></code></pre></div><p>查看文件格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>:set ff
</span></span></code></pre></div><p>更改文件格式为unix：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>:set ff=unix
</span></span><span style=display:flex><span>或者
</span></span><span style=display:flex><span>:set fileformat=unix
</span></span></code></pre></div><h2 id=创建webhook后端运行代码>创建Webhook后端运行代码</h2><p>在上文deploy.sh文件同一目录下创建webhook.js文件，内容如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;http&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>createHandler</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;github-webhook-handler&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createHandler</span>({ <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/auto_deploy&#39;</span>, <span style=color:#a6e22e>secret</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;xxxx&#39;</span> })
</span></span><span style=display:flex><span><span style=color:#75715e>// 上面的 secret 在配置Github上webhook时需要用到
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>run_cmd</span>(<span style=color:#a6e22e>cmd</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>callback</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>spawn</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;child_process&#39;</span>).<span style=color:#a6e22e>spawn</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spawn</span>(<span style=color:#a6e22e>cmd</span>, <span style=color:#a6e22e>args</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>resp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>stdout</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;data&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>buffer</span>) { <span style=color:#a6e22e>resp</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>buffer</span>.<span style=color:#a6e22e>toString</span>(); });
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>stdout</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;end&#39;</span>, <span style=color:#66d9ef>function</span>() { <span style=color:#a6e22e>callback</span> (<span style=color:#a6e22e>resp</span>) });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>404</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>(<span style=color:#e6db74>&#39;no such location&#39;</span>)
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>10000</span>)<span style=color:#75715e>//监听本地10000端口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;error&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error:&#39;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span>)
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;push&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Received a push event for %s to %s&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>ref</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run_cmd</span>(<span style=color:#e6db74>&#39;sh&#39;</span>, [<span style=color:#e6db74>&#39;./deploy.sh&#39;</span>,<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>repository</span>.<span style=color:#a6e22e>name</span>], <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>text</span>){ <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>text</span>) });
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#75715e>//deploy.sh为自动化部署的脚本文件
</span></span></span></code></pre></div><h2 id=使用pm2进程管理器运行webhookjs>使用pm2进程管理器运行webhook.js</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>pm2 start webhook.js
</span></span></code></pre></div><p>如果在运行的时候如果提示 github-webhook-handler is not defined 未找到 ，可以在目录中执行 npm link github-webhook-handler。
可以使用以下命令查看端口是否正常使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>netstat -tlnp|grep 10000
</span></span></code></pre></div><p>正常结果如下图：
<img src=/imgs/img-lazy-loading.gif data-src=https://i.imgur.com/AoGYaoE.png alt=tcp></p><p>目前为止，一切顺利的话，webhook就在服务器上跑了起来，如果需要映射到公网的80端口，那么需要配置一下Nginx反向代理。</p><h2 id=配置nginx>配置Nginx</h2><p>配置Nginx使访问网站80端口的**/auto_deploy<strong>URL转发到本地的10000端口，在</strong>/etc/nginx/nginx.conf**文件中加入如下配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>	server
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	  # 80端口是http正常访问的接口
</span></span><span style=display:flex><span>	  listen 80;
</span></span><span style=display:flex><span>	  server_name xxx.com;
</span></span><span style=display:flex><span>	  location /auto_deploy {
</span></span><span style=display:flex><span>        proxy_pass http://127.0.0.1:10000;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>重启Nginx：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>sudo systemctl restart nginx.service
</span></span></code></pre></div><h2 id=配置github上的webhook>配置Github上的Webhook</h2><p>进入Github项目地址，点击设置按钮，找到Webhooks，进行如下配置：
<img src=/imgs/img-lazy-loading.gif data-src=https://i.imgur.com/c1kTXAQ.jpg alt>
其中，Secret项需要和webhook.js文件中的保持一致，Content type 选择application/json。
不出意外的话可以看到最近提交是否成功。
<img src=/imgs/img-lazy-loading.gif data-src=https://i.imgur.com/AlSPQ6A.jpg alt></p></div><footer class=post-footer><div class=post-tags><a href=/tags/git>Git</a>
<a href=/tags/nginx>Nginx</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/%E5%85%B3%E4%BA%8Evue-cli-npm-run-build%E7%A9%BA%E7%99%BD%E9%A1%B5%E9%97%AE%E9%A2%98/ rel=next title="关于vue-cli npm run build空白页问题"><i class="fa fa-chevron-left"></i> 关于vue-cli npm run build空白页问题</a></div><div class="post-nav-prev post-nav-item"><a href=/post/%E5%85%B3%E4%BA%8Easp.net%E4%B8%ADajax%E8%AF%B7%E6%B1%82%E9%94%99%E8%AF%AF%E7%9A%84%E9%97%AE%E9%A2%98/ rel=prev title=关于ASP.NET中Ajax请求错误的问题>关于ASP.NET中Ajax请求错误的问题
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2023</span>
<span class=with-love><i class="fa fa-paper-plane"></i></span>
<span class=author itemprop=copyrightHolder>Teoan</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://teoan.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.1","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.5207e106e9f92dcba41e11e145b3dea597901a731ea853825859c3c82c35adf6.js defer></script></body></html>